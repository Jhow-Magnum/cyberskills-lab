FROM debian:12-slim

LABEL maintainer="CTF SENAI" description="CenÃ¡rio Network Security - 3 Desafios"

# Instalar apenas ferramentas essenciais
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-server nmap netcat-openbsd iproute2 iputils-ping file \
    && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# SSH config
RUN mkdir -p /var/run/sshd && echo 'root:root' | chpasswd \
    && sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Criar desafios
RUN mkdir -p /root/network \
    && echo "172.18.0.2" > /root/network/ip_flag.txt \
    && echo "5" > /root/network/ports_flag.txt \
    && echo "22" > /root/network/ssh_port_flag.txt

# ServiÃ§os fake
RUN printf '#!/bin/bash\nnc -l -p 8080 &\nnc -l -p 9000 &\nnc -l -p 9001 &\n' > /start-services.sh && chmod +x /start-services.sh

# Criar README educativo
RUN printf '=== CYBERSKILLS LAB - NETWORK ANALYSIS ===\n\nBem-vindo aos desafios de AnÃ¡lise de Rede!\nVocÃª estÃ¡ logado como '\''user'\'' Explore a rede.\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n3 DESAFIOS DE ANÃLISE DE REDE\n\nObjetivo: Identificar serviÃ§os, portas e configuraÃ§Ãµes de rede.\n\nComandos essenciais:\nâ€¢ ip addr                  - Mostra endereÃ§os IP\nâ€¢ hostname -I              - IP do host\nâ€¢ netstat -tuln            - Portas abertas (TCP/UDP)\nâ€¢ ss -tuln                 - Alternativa ao netstat\nâ€¢ nmap localhost           - Scan de portas\nâ€¢ ps aux                   - Processos rodando\n\nDicas gerais:\n1. ServiÃ§os de rede escutam em portas especÃ­ficas\n2. SSH geralmente usa porta 22\n3. HTTP usa porta 80, HTTPS usa 443\n4. Portas LISTEN indicam serviÃ§os ativos\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nðŸ’¡ Usando Google/IA:\n\nâœ… Pergunte: "Como ver portas abertas no Linux?"\nâœ… Pergunte: "DiferenÃ§a entre netstat e ss?"\nâœ… Pergunte: "Como descobrir IP do container?"\n\nâŒ NÃ£o peÃ§a soluÃ§Ãµes diretas!\n\nAPRENDA networking, nÃ£o apenas resolva!\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nComece explorando! Digite: ip addr\n' > /home/user/README.txt \
    && chown user:user /home/user/README.txt

# Script de inicializaÃ§Ã£o
RUN printf '#!/bin/bash\n/start-services.sh\n/usr/sbin/sshd -D\n' > /start.sh && chmod +x /start.sh

EXPOSE 22
CMD ["/start.sh"]
